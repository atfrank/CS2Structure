---
title: "cs2ss manuscript analysis"
output:
  pdf_document: default
  html_document: default
---

```{r setup}
suppressPackageStartupMessages(require(viridis))
suppressPackageStartupMessages(library(caret))
knitr::opts_knit$set(root.dir = normalizePath("../.."))
```

source user functions
```{r}
source("scripts/analysis/functions.R")
```

## Figure 1: Neural network illustration
```{r}
draw_neural_network()
```

## Figure 2: CS2BPS assessment
load cs2bps derived classifier assessment
```{r}
data <- load_model_accuracy()
print_model_summary(data, metrics = c("sen", "spec", "overall"))
```
plot cs2bps TPR
```{r}
plot_color_bar(data, "sen")
```
plot cs2bps TNR
```{r}
plot_color_bar(data, "spec")
```

## Figure 3: CS-Folding assessment
load TPR and PPV of heuristically selected secondary structures
```{r}
# did not calculate consistency score
data <- load_model_accuracy(file = "data/ss_scorer/heuristic_scorer_summary.txt", colnames = c("id", "sens", "PPV")) # delete sub-optimal structures
data$sens <- as.numeric(gsub("*%","",as.character(data$sens)))/100
data$PPV <- as.numeric(gsub("*%","",as.character(data$PPV)))/100
print_model_summary(data, metrics = c("sens", "PPV"))
plot_color_bar(data, "sens")
plot_color_bar(data, "PPV")
```

## Table 1-1: base-pairing status prediction accuracy of different residue types
```{r, results = "hold"}
rnas <- get(load("info/rnas.RData"))
pred <- load_base_pairing_predictions(rnas, pred_cols = c("resid","bp_pred"), all_rnas = TRUE, method = "residue")
cat("Type\tTPR\tTNR\tInstances\n")
cat("G\t",residue_wise_cs2bps_metrics("G", pred, metric = "TPR"),"\t",residue_wise_cs2bps_metrics("G", pred, metric = "TNR"), "\t",residue_wise_cs2bps_metrics("G", pred, metric = "number"),"\n")

cat("C\t",residue_wise_cs2bps_metrics("C", pred, metric = "TPR"),"\t",residue_wise_cs2bps_metrics("C", pred, metric = "TNR"), "\t",residue_wise_cs2bps_metrics("C", pred, metric = "number"),"\n")

cat("A\t",residue_wise_cs2bps_metrics("A", pred, metric = "TPR"),"\t",residue_wise_cs2bps_metrics("A", pred, metric = "TNR"), "\t",residue_wise_cs2bps_metrics("A", pred, metric = "number"),"\n")

cat("U\t",residue_wise_cs2bps_metrics("U", pred, metric = "TPR"),"\t",residue_wise_cs2bps_metrics("U", pred, metric =  "TNR"),"\t",residue_wise_cs2bps_metrics("U", pred, metric = "number"),"\n")
```
## Table 1-2: base-pairing status prediction accuracy of different base-pair types
```{r,results = "hold"}
pred <- load_base_pairing_predictions(rnas, pred_cols = c("resid","bp_pred"), all_rnas = TRUE, method = "basepair")
cat("Type\tTPR\tInstances\n")
cat("GC\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "TPR"),"\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "number"),"\n")
cat("AU\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "TPR"),"\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "number"),"\n")
cat("GU\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "TPR"),"\t",basepair_wise_cs2bps_metrics("AU", pred, metric = "number"),"\n")
```
## Table 2: CS-Folding accuracy
select csfold structures based on:
1) cs2bps consistency;
2) folding energy;
candidate structures are:
Fold with and without cs2bps prediction;
MaxExpect with and without cs2bps predictions;
ProbKnot with and without cs2bps predictions.

copy final structure to 'ss_selected'
```{r}
structure_selection_using_cs2bps_and_energy(rnas, from_path = "data/ss_with_cs/", to_path = "data/ss_selected/", methods = c("FLpr1_prob_avg","MEpr1_prob_avg","PKpr1_prob_avg","fold","maxexpect","probknot"), rewrite = T)
```
CS-Folding accuracy (with and without cs data)
```{r, results = "hold"}
Fold_with_cs <- load_scorer_accuracy("data/ss_scorer/FLpr1_prob_avg_scorer_summary.txt")
Fold_alone <- load_scorer_accuracy("data/ss_scorer/fold_scorer_summary.txt")
MaxExpect_with_cs <- load_scorer_accuracy("data/ss_scorer/MEpr1_prob_avg_scorer_summary.txt")
MaxExpect_alone <- load_scorer_accuracy("data/ss_scorer/maxexpect_scorer_summary.txt")
ProbKnot_with_cs <- load_scorer_accuracy("data/ss_scorer/PKpr1_prob_avg_scorer_summary.txt")
ProbKnot_alone <- load_scorer_accuracy("data/ss_scorer/probknot_scorer_summary.txt")
CSFold <- load_scorer_accuracy("data/ss_scorer/heuristic_scorer_summary.txt")

cat("Type\t\tTPR\t\t\tPPV\n")
cat("Fold\t",round(mean(Fold_alone$TPR),2),"/",round(mean(Fold_with_cs$TPR),2),"\t",round(mean(Fold_alone$PPV),2),"/",round(mean(Fold_with_cs$PPV),2),"\n")
cat("PK\t",round(mean(ProbKnot_alone$TPR),2),"/",round(mean(ProbKnot_with_cs$TPR),2),"\t",round(mean(ProbKnot_alone$PPV),2),"/",round(mean(ProbKnot_with_cs$PPV),2),"\n")
cat("ME\t",round(mean(MaxExpect_alone$TPR),2),"/",round(mean(MaxExpect_with_cs$TPR),2),"\t",round(mean(MaxExpect_alone$PPV),2),"/",round(mean(MaxExpect_with_cs$PPV),2),"\n")
cat("CSFold\t",round(mean(CSFold$TPR),2),"\t\t",round(mean(CSFold$PPV),2),"\n")
```
## Table 3: CS-Folding TPR by base-pair type
```{r, results = "hold"}
data <- load_secondary_structure_predictions(rnas)
cat("Type\tTPR\tInstances\n")
cat("GC\t",basepair_wise_csfold_metrics("GC", data, metric = "TPR"),"\t",basepair_wise_csfold_metrics("GC", data, metric = "number"),"\n")
cat("AU\t",basepair_wise_csfold_metrics("AU", data, metric = "TPR"),"\t",basepair_wise_csfold_metrics("AU", data, metric = "number"),"\n")
cat("GU\t",basepair_wise_csfold_metrics("GU", data, metric = "TPR"),"\t",basepair_wise_csfold_metrics("GU", data, metric = "number"),"\n")
```





